<?php

/**
 * @file
 * Manage Application Submission Module
 */
use Drupal\Component\Utility\Variable;
use Drupal\webform\Utility\WebformFormHelper;
use Drupal\Core\Render\Element;
use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\AlertCommand;
use Drupal\Core\Form\FormStateInterface;

use Drupal\application\Controller\ApplicationController;
use Drupal\application\Controller\SBALFAController;



function application_form_webform_submission_apply_for_ppp_loan_edit_all_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);

    application_verify_netearnings($form, $form_state);
}

function application_form_webform_submission_apply_for_ppp_loan_edit_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    #$elements = WebformFormHelper::flattenElements($form);
    
    #$form["elements"]["loan_officer_page"]["verified_net_earnings"]['#prefix'] = '<div id="loan-form-ajax-wrapper">';
    #$form["elements"]["loan_officer_page"]["verified_net_earnings"]['#suffix'] = '</div>';
    
    $form["elements"]["loan_officer_page"]["sba_response"]["#prefix"] = '<div id="sba-response-ajax-wrapper">';
    $form["elements"]["loan_officer_page"]["sba_response"]["#suffix"] = "</div>";
    
    $form["elements"]["loan_officer_page"]["btn_cancel_loan"] = [
        '#type' => 'button',
        '#value' => t('Cancel Loan'),
        '#ajax' => [
            'callback' => 'application_cancel_loan',
            'event' => 'click',
            'wrapper' => 'sba-response-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ]
    ];

    $form["elements"]["loan_officer_page"]["btn_send_to_sba"] = [
        '#type' => 'button',
        '#value' => t('Send to SBA'),
        '#ajax' => [
            'callback' => 'application_send_to_sba',
            'event' => 'click',
            'wrapper' => 'sba-response-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => 'Sending...',
            ],
        ],
        '#weight' => 5,
    ];

}

function application_form_webform_submission_apply_for_ppp_loan_add_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);

    #dpm($elements);
    
    #$elements["borrower_email"]["#default_value"] = \Drupal::currentUser()->getEmail();

    $elements["borrower_email"]["#default_value"] = "yun@rmdslab.com";

    $application_controller = new ApplicationController($elements);

    $application_controller->login();

    $form['actions']['submit']['#submit'][]  = 'application_form_submit';

    #$form['actions']['wizard_next']['#submit'][] = 'application_verify_netearnings';

    

}

function application_form_webform_submission_apply_for_flp_loan_add_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);
    // calculate forgive amount
    $order = array("$", " ", ",");

    $forgiveness_amount = str_replace($order, "", $elements["forgiveness_calculation"]["#default_value"]);
    $eidl_amount = str_replace($order, "", $elements["eidl_advance_amount_if_applicable_"]["#default_value"]);

    $forgive_amount = $forgiveness_amount - $eidl_amount;

    $elements["forgive_amount"]["#default_value"] = $forgive_amount;
    $controller = new SBALFAController($elements);
    $controller->login();
    $form['actions']['submit']['#submit'][]  = 'application_send_fogive_form';
}

function application_form_submit(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $application_controller = new ApplicationController($elements);
    $application_controller->login();
    $result = $application_controller->content();

}

function application_send_fogive_form(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $controller = new SBALFAController($elements);
    $controller->login();
    $result = $controller->sendForm();
    if (!empty($result) && isset($result["envelope_id"])) {
        $entity = $form_state->getFormObject()->getEntity();
        $data = $entity->getData();
        $data["envelope_id"] = $result["envelope_id"];
        $entity->setData($data);
        $entity->save();
    }
}

function application_verify_netearnings(array &$form, FormStateInterface $form_state) {
    #$response = new AjaxResponse();

    $elements = WebformFormHelper::flattenElements($form);

    /*
    if (floatval($elements["verified_net_earnings"]["#default_value"]) > 0) {
        return;
    }

    $file_id = $form["elements"]["request_document_1"]["1040_schedule_c"]["#default_value"][0];
    
    if ($file_id) {
        $file = \Drupal\file\Entity\File::load($file_id);
        $filename = $file->getFilename();

        $submission_id = $form["elements"]["request_document_1"]["1040_schedule_c"]["#webform_submission"];

        $full_filename = $submission_id . '/' . $filename;
        
        $client = \Drupal::httpClient();
        $request = $client->post('http://161.35.226.185:8000/detect_1040_schedule_C', [
            'form_params' => [
                'filename' => $full_filename,
            ],
            'headers' => [
                'Content-type' => 'application/x-www-form-urlencoded',
            ],
        ]);
        

        $result = json_decode($request->getBody());
    
        $form["elements"]["loan_officer_page"]["verified_net_earnings"]["#value"] = $result->{"response"};
        $form["elements"]["loan_officer_page"]["verified_net_earnings"]["#default_value"] = $result->{"response"};
        $elements["verified_net_earnings"]["#default_value"] = $result->{"response"};
    }
    */
}

function application_cancel_loan(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $data = [
        'MethodNamePhysical' => 'Servicing2',
        'CLSUsername' => 'alctester',
        'CLSPassword' => 'Squall39478',
        'CLSPIN' => '303330',
        'EMail' => 'yun@rmdslab.com',
        'FormatIn' => 'XML',
        'FormatOut' => 'JSON',
        'RequestData' => "<SBA_ETran version=\"6.0\"><SBALoan action=\"cancel\"><Loan action=\"update\"><LoanApplicNmb>155878</LoanApplicNmb><LoanNmb>8936745005</LoanNmb></Loan></SBALoan></SBA_ETran>",
        'SoftwareVendorCode' => "WZHZUDAQX",
	    'SoftwareVendorName' => "AMERICANLENDINGCENTER"
    ];

    $json_data = json_encode($data);
    
    $client = \Drupal::httpClient();
    $request = $client->post('https://catweb2.sba.gov/rest/elend/flexible/SharedEntryPoint', [
        'body' => $json_data,
        'headers' => [
            'Content-type' => 'application/json',
        ],
    ]);


    $result = json_decode($request->getBody());
    
    #dpm(json_decode($result->ResponseData));
    
    $form["elements"]["loan_officer_page"]["sba_response"]["#value"] = $result->{"ResponseData"};



    return $form["elements"]["loan_officer_page"]["sba_response"];
}

function application_send_to_sba(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $request_data_str = application_json_builder($elements);
    #dpm($request_data_str);
    $data = [
        'MethodNamePhysical' => 'Originate3',
        'CLSUsername' => 'alctester',
        'CLSPassword' => 'Squall39478',
        'CLSPIN' => '303330',
        'EMail' => 'yun@rmdslab.com',
        'FormatIn' => 'JSON',
        'RequestData' => $request_data_str,
        'SoftwareVendorCode' => "WZHZUDAQX",
	    'SoftwareVendorName' => "AMERICANLENDINGCENTER"
    ];

    $json_data = json_encode($data);
    
    $client = \Drupal::httpClient();
    $request = $client->post('https://catweb2.sba.gov/rest/elend/flexible/SharedEntryPoint', [
        'body' => $json_data,
        'headers' => [
            'Content-type' => 'application/json',
        ],
    ]);


    $result = json_decode($request->getBody());
    
    #dpm(json_decode($result->ResponseData));
    
    $form["elements"]["loan_officer_page"]["sba_response"]["#value"] = $result->{"ResponseData"};



    return $form["elements"]["loan_officer_page"]["sba_response"];
}

function application_cancel_loan_builder(array &$elements) {
    $request_data = new stdClass();
    $request_data->version = "6.0";
    $App = new stdClass();
    $App->action = "cancel";
    $LoanApplication = new stdClass();
    $LoanApplication->action = "update";
    $LoanApplication->LoanApplicNmb = "155878";
    $LoanApplication->LoanNmb = "89367450-05";
    $App->LoanApplication = [$LoanApplication];
    $request_data->App = $App;
    return json_encode($request_data);
}

function application_json_builder(array &$elements) {
    #dpm($elements);
    
    $request_data = new stdClass();
    $request_data->version = "6.0";
    

    $App = new stdClass();

    $LoanApplication = new stdClass();
    $LoanApplication->action = "insert";
    $LoanApplication->_comment = "test app #155585";
    $LoanApplication->AgentInvolved = "N";
    $LoanApplication->BusinessAgeCd = "0";
    $LoanApplication->CollateralInd = "N";
    $LoanApplication->CurrEmpQty = "0";
    $LoanApplication->EligPassiveCompanyInd = "Y";
    $LoanApplication->FrnchiseInd = "N";
    $LoanApplication->FullAmortPymtInd = "Y";
    $LoanApplication->InjectionInd = "Y";
    $LoanApplication->InterestStructureCd = "V";
    $LoanApplication->JobsCreatdQty = "1";
    $LoanApplication->JobsRetaindQty = "3";
    $LoanApplication->LenderCntctEmail = "yun@rmdslab.com";
    $LoanApplication->LenderCntctFirstName = "John";
    $LoanApplication->LenderCntctLastName = "Shen";
    $LoanApplication->LenderCntctPhnNmb = "5624490139";
    $LoanApplication->LenderCntctTitl = "CEO";
    $LoanApplication->LifeInsurRqmtInd = "Y";
    $LoanApplication->LoanBusinessEstDt = "2020-02-11 00:00:00.0";
    $LoanApplication->LoanName = "Planet Express LLC";
    $LoanApplication->LoanTermMnths = "120";
    $LoanApplication->LoanTermStartTypInd = "N";
    $LoanApplication->MnthsIntrstOnlyQty = "0";
    $LoanApplication->NAICSCd = "812210";
    $LoanApplication->NoteDt = "2020-10-26 00:00:00.0";
    $LoanApplication->ProcessingMethodCd = "7AG";
    $LoanApplication->ProjectCityName = "Huntington";
    $LoanApplication->ProjectStCd = "IN";
    $LoanApplication->ProjectStrtName1 = "100 S Park Drive";
    $LoanApplication->ProjectStrtName2 = "";
    $LoanApplication->ProjectZip4Cd = "2633";
    $LoanApplication->ProjectZipCd = "46750";
    $LoanApplication->PymtAmt = "30000.00";
    $LoanApplication->PymtTypeCode = "F";
    $LoanApplication->ReconsiderationInd = "N";
    $LoanApplication->RequestedAmt = "240000.00";
    $LoanApplication->RuralUrbanInd = "R";
    $LoanApplication->SBAGntyPct = "75.000";
    $LoanApplication->UnderwritingBy = "SBA";
    $App->LoanApplication = [$LoanApplication];
    
    $Borrower = new stdClass();
    $Borrower->action = "insert";
    $Borrower->TaxId = "0844669294";
    $Borrower->BusinessPersonInd = "B";
    $Borrower->BnkrptcyInd = "N";
    $Borrower->BooksToLenderWithinDays = "180";
    $Borrower->BusDUNSNmb = "069752764";
    $Borrower->BusinessName = $elements["business_name"]["#default_value"];
    $Borrower->BusOutstandingDebtInd = "N";
    $Borrower->BusPrimCntctNm = "Donald D Duck";
    $Borrower->ControlInterestType = "9";
    $Borrower->CurrOwnrshpEstblshDt = "Feb 11 2020 12:00AM";
    $Borrower->EPCOperatingCompnyCd = "3";
    $Borrower->ExtrnlCreditScorInd = "N";
    $Borrower->FedDisqualifiedInd = "N";
    $Borrower->GamblingOrSexualNatureInd = "N";
    $Borrower->InsurLiabInd = "Y";
    $Borrower->InsurLiabProductInd = "Y";
    $Borrower->InsurLiquorInd = "N";
    $Borrower->InsurMalpracticeInd = "N";
    $Borrower->InsurOtherInd = "N";
    $Borrower->InsurWorkersCompInd = "Y";
    $Borrower->LawsuitInd = "N";
    $Borrower->LegalOrgnztnCd = "4";
    $Borrower->MailCityName = "Huntington";
    $Borrower->MailCountryCd = "US";
    $Borrower->MailStCd = "IN";
    $Borrower->MailStrtName1 = "100 S Park Drive";
    $Borrower->MailStrtName2 = "";
    $Borrower->MailZip4Cd = "";
    $Borrower->MailZipCd = "46750";
    $Borrower->NonFedEmpInd = "Y";
    $Borrower->NonFmrSBAEmpInd = "Y";
    $Borrower->NonGS13EmpInd = "Y";
    $Borrower->NonLegBrnchEmpInd = "Y";
    $Borrower->NonSBACEmpInd = "Y";
    $Borrower->PaymentsLessThanCCInd = "";
    $Borrower->PhysCityName = "Huntington";
    $Borrower->PhysCountryCd = "US";
    $Borrower->PhysPostalCd = "";
    $Borrower->PhysStCd = "IN";
    $Borrower->PhysStrtName1 = "100 S Park Drive";
    $Borrower->PhysStrtName2 = "";
    $Borrower->PhysZip4Cd = "";
    $Borrower->PhysZipCd = "46750";
    $Borrower->PrevGovFinInd = "N";
    $Borrower->PrimaryBusinessInd = "Y";
    $Borrower->PrimaryPhone = "3013561710";
    $Borrower->PriorSBALoanInd = "N";
    $Borrower->LastName = $elements["last_name"]["#default_value"];

    $Borrower2 = new stdClass();
    $Borrower2->action = "insert";
    $Borrower2->TaxId = "0844692533";
    $Borrower2->BusinessPersonInd = "B";
    $Borrower2->BnkrptcyInd = "N";
    $Borrower2->BooksToLenderType = "12";
    $Borrower2->BooksToLenderWithinDays = "180";
    $Borrower2->BusinessName = "GHQ Realty LLC";
    $Borrower2->BusOutstandingDebtInd = "N";
    $Borrower2->BusPrimCntctNm = "Donald D Duck";
    $Borrower2->ControlInterestType = "7";
    $Borrower2->CurrOwnrshpEstblshDt = "Feb 12 2020 12:00AM";
    $Borrower2->EPCOperatingCompnyCd = "2";
    $Borrower2->ExtrnlCreditScorInd = "N";
    $Borrower2->FedDisqualifiedInd = "N";
    $Borrower2->GamblingOrSexualNatureInd = "N";
    $Borrower2->LawsuitInd = "N";
    $Borrower2->LegalOrgnztnCd = "4";
    $Borrower2->NonFedEmpInd = "Y";
    $Borrower2->NonFmrSBAEmpInd = "Y";
    $Borrower2->NonGS13EmpInd = "Y";
    $Borrower2->NonLegBrnchEmpInd = "Y";
    $Borrower2->NonSBACEmpInd = "Y";
    $Borrower2->PhysCityName = "Huntington";
    $Borrower2->PhysCountryCd = "US";
    $Borrower2->PhysStCd = "IN";
    $Borrower2->PhysStrtName1 = "100 S Park Drive";
    $Borrower2->PhysStrtName2 = "";
    $Borrower2->PhysZip4Cd = "";
    $Borrower2->PhysZipCd = "46750";
    $Borrower2->PrevGovFinInd = "N";
    $Borrower2->PrimaryBusinessInd = "N";
    $Borrower2->PrimaryPhone = "3013561710";
    $Borrower2->PriorSBALoanInd = "N";
    $App->Borrower = [$Borrower, $Borrower2];
    
    $BusAppr = new stdClass();
    $BusAppr->action = "insert";
    $BusAppr->Ind = "ABV";
    $App->BusAppr = [$BusAppr];

    $ChangeOfOwnership = new stdClass();
    $ChangeOfOwnership->action = "insert";
    $ChangeOfOwnership->BuyerEqtyBorrAmt = "0.00";
    $ChangeOfOwnership->BuyerEqtyCashAmt = "0.00";
    $ChangeOfOwnership->BuyerEqtyOthAmt = "0.00";
    $ChangeOfOwnership->Loan7aPymtAmt = "1946100.00";
    $ChangeOfOwnership->SellerFinanFullStbyAmt = "0.00";
    $ChangeOfOwnership->SellerFinanNonFullStbyAmt = "0.00";
    #$ChangeOfOwnership->TotalApprAmt = "1884000.00";
    $App->ChangeOfOwnership = [$ChangeOfOwnership];
    
    $App->Collateral = [];
    
    $CreditUnavailReasons = new stdClass();
    $CreditUnavailReasons->action = "insert";
    $CreditUnavailReasons->CreditUnavailReasonCd = "1";
    $CreditUnavailReasons->CreditUnavailReasonCommnt = "SIGNIFICANT COLLATERAL SHORTFALL";
    $App->CreditUnavailReasons = [$CreditUnavailReasons];
    
    $Eligibility = new stdClass();
    $Eligibility->action = "insert";
    $Eligibility->EligibleCd = "102";
    $Eligibility->EligibleInd = "Y";
    $App->Eligibility = [$Eligibility];

    $Injection = new stdClass();
    $Injection->action = "insert";
    $Injection->InjctnAmt = "108000.00";
    $Injection->InjctnOthDescTxt = "Down payment on purchase";
    $Injection->InjctnTermNotLessThanYrNmb = "";
    $Injection->InjctnTypCd = "C";
    $App->Injection = [$Injection];
    
    $Interest = new stdClass();
    $Interest->action = "insert";
    $Interest->Phase = "1";
    $Interest->AdjustPeriodCd = "Q";
    $Interest->AdjustPeriodMnths = "";
    $Interest->BaseIntrstRatePct = "4.75000";
    $Interest->BaseRateSourcTypCd = "WSJ";
    $Interest->BorrIntrstRatePct = "5.75000";
    $Interest->FirstRateAdjustDt = "2020-11-01 00:00:00.0";
    $Interest->IntrstGuaranteeInd = "F";
    $Interest->IntrstTypInd = "V";
    $Interest->ShareOfTotalMnths = "120";
    $Interest->ShareOfTotalPct = "100.000";
    $App->Interest = [$Interest];
    
    $PartnerInformation = new stdClass();
    $PartnerInformation->action = "insert";
    $PartnerInformation->LocationId = "507148";
    $App->PartnerInformation = [$PartnerInformation];
    
    $Principal = new stdClass();
    $Principal->action = "insert";
    $Principal->BusinessTaxId = "0844669294";
    $Principal->TaxId = "1306849681";
    $Principal->BusinessPersonInd = "P";
    $Principal->BirthCityName = "Wabash";
    $Principal->BirthCntryName = "USA";
    $Principal->BirthDt = "Apr 11 1980 12:00AM";
    $Principal->BirthStCd = "IN";
    $Principal->BnkrptcyInd = "N";
    $Principal->ControlInterestType = "7";
    $Principal->CreditScorSourcCd = "14";
    $Principal->EthnicCd = "HN";
    $Principal->ExtrnlCreditScorDt = "Jan 21 2020 12:00AM";
    $Principal->ExtrnlCreditScorInd = "Y";
    $Principal->ExtrnlCreditScorNmb = "790";
    $Principal->FirstName = "Donald";
    $Principal->GndrCd = "M";
    $Principal->GntyInd = "Y";
    $Principal->GntyTypCd = "1";
    $Principal->InsuranceAmt = "1100000.00";
    $Principal->InsuranceDisabInd = "N";
    $Principal->InsuranceLifeInd = "Y";
    $Principal->LastName = "Duck";
    $Principal->LawsuitInd = "N";
    $Principal->LglActnInd = "N";
    $Principal->MiddleInitial = "D";
    $Principal->NoNCAInd = "N";
    $Principal->OwnrshpInBusinessPct = "90.00";
    $Principal->PhysCityName = "Huntington";
    $Principal->PhysCountryCd = "US";
    $Principal->PhysStCd = "IN";
    $Principal->PhysStrtName1 = "142 Folk Street";
    $Principal->PhysStrtName2 = "";
    $Principal->PhysZip4Cd = "";
    $Principal->PhysZipCd = "46750";
    $Principal->Title = "Manager";
    $Principal->USCitznInd = "US";
    $Principal->VetCd = "1";
    $Principal->VetCertInd = "N";
    $App->Principal = [$Principal];

    $PrincipalRace = new stdClass();
    $PrincipalRace->action = "insert";
    $PrincipalRace->TaxId = "1306849681";
    $PrincipalRace->BusinessPersonInd = "P";
    $PrincipalRace->RaceCd = "7";

    $App->PrincipalRace = [$PrincipalRace];

    $SpecialPurpose = new stdClass();
    $SpecialPurpose->action = "insert";
    $SpecialPurpose->SpcPurpsLoanCd = "NOSP";
    $App->SpecialPurpose = [$SpecialPurpose];
    
    $UseOfProceeds = new stdClass();
    $UseOfProceeds->action = "insert";
    $UseOfProceeds->ProceedTypCd = "A";
    $UseOfProceeds->LoanProceedTypCd = "16";
    $UseOfProceeds->ProceedAmt = "1946100.00";
    $UseOfProceeds->PurchaseAgrmtNCAInd = "Y";
    $UseOfProceeds->PurchaseIntngblAssetAmt = "1800000.00";
    $UseOfProceeds->RefDescTxt = "Handy Example";
    
    $App->UseOfProceeds = [$UseOfProceeds];
    $request_data->App = [$App];

    return json_encode($request_data);
}

function application_form_webform_submission_forgiveness_form_add_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);

    #$elements["borrower_email"]["#default_value"] = \Drupal::currentUser()->getEmail();

    $elements["borrower_email"]["#default_value"] = "yunforreg@gmail.com";

    $application_controller = new ApplicationController($elements);

    $application_controller->login();

    #$form['actions']['submit']['#submit'][]  = 'application_forgiveness_form_submit';

    #$form['actions']['wizard_next']['#submit'][] = 'application_verify_netearnings';

    
    $form["elements"]["envelope_id"]["#prefix"] = '<div id="envelope-id-ajax-wrapper">';
    $form["elements"]["envelope_id"]["#suffix"] = "</div>";
    
    $form["elements"]["btn_create_envelope"] = [
        '#type' => 'button',
        '#value' => t('Create Envelope'),
        '#ajax' => [
            'callback' => 'application_create_envelope',
            'event' => 'click',
            'wrapper' => 'envelope-id-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ]
    ];
    
    $form["elements"]["document_name"]["#prefix"] = '<div id="document-name-ajax-wrapper">';
    $form["elements"]["document_name"]["#suffix"] = '</div>';

    $form["elements"]["btn_download_document"] = [
        '#type' => 'button',
        '#value' => t('Download Document'),
        '#ajax' => [
            'callback' => 'application_download_document',
            'event' => 'click',
            'wrapper' => 'document-name-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ]
    ];

}

function application_create_envelope(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    
    $application_controller = new ApplicationController($elements);
    $application_controller->login();
    $result = $application_controller->buildForgivenessForm();

    $form["elements"]["envelope_id"]["#value"] = $result["envelope_id"];
    $form["elements"]["envelope_id"]["#default_value"] = $result["envelope_id"];
    
    return $form["elements"]["envelope_id"];
}

function application_forgiveness_form_submit(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $application_controller = new ApplicationController($elements);
    $application_controller->login();
    #$result = $application_controller->buildForgivenessForm();

    
    #$elements["envelope_id"]["#default_value"] = $result["envelope_id"];
    
    #$entity = $form_state->getFormObject()->getEntity();
    #$data = $entity->getData();
    #$data["envelope_id"] = $result["envelope_id"];
    #$entity->setData($data);
    #$entity["#data"]["envelope_id"] = $result["envelope_id"];
    #$entity->save();

    $results = $application_controller->downloadForgivenessForm();
}

function application_download_document(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    
    $application_controller = new ApplicationController($elements);
    $application_controller->login();
    $results = $application_controller->downloadForgivenessForm();

    $form["elements"]["document_name"]["#value"] = $results;
    $form["elements"]["document_name"]["#default_value"] = $results;
    
    return $form["elements"]["document_name"];
}

function application_form_webform_submission_apply_for_flp_loan_edit_all_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);
    
    #$form["elements"]["lender_confirmation"]["sba_response"]["#prefix"] = '<div id="sba-response-ajax-wrapper">';
    #$form["elements"]["lender_confirmation"]["sba_response"]["#suffix"] = "</div>";
    $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"]["#prefix"] = '<div id="sba-response-ajax-wrapper">';
    $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"]["#suffix"] = "</div>";

    $form["elements"]["lender_confirmation"]["btn_send_request"] = [
        '#type' => 'button',
        '#value' => 'Send to SBA',
        '#ajax' => [
            'callback' => 'application_send_request',
            'event' => 'click',
            'wrapper' => 'sba-response-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ]
        
    ];
    /*
    $form["elements"]["lender_confirmation"]["btn_upload_document"] = [
        '#type' => 'button',
        '#value' => 'Upload',
        '#ajax' => [
            'callback' => 'application_upload_document',
            'event' => 'click',
            'wrapper' => 'sba-response-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ]
    ];
    */
    $form["elements"]["lender_confirmation"]["docusign_file_link"] = [
        '#type' => 'inline_template',
        '#template' => '',
        "#prefix" => '<div id="docusign-file-ajax-wrapper">',
        "#suffix" => "</div>"
    ];

    // Button of download file
    $form["elements"]["lender_confirmation"]["btn_download_document"] = [
        '#type' => 'button',
        '#value' => 'Download Docusign Form',
        '#ajax' => [
            'callback' => 'application_download_docusign_document',
            'event' => 'click',
            'wrapper' => 'docusign-file-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ]
    ];

    // calculate forgive amount
    $order = array("$", " ", ",");

    $forgiveness_amount = str_replace($order, "", $elements["forgiveness_calculation"]["#default_value"]);
    $eidl_amount = str_replace($order, "", $elements["eidl_advance_amount_if_applicable_"]["#default_value"]);

    $forgive_amount = $forgiveness_amount - $eidl_amount;
    $elements["forgive_amount"]["#default_value"] = $forgive_amount;
    
    $controller = new SBALFAController($elements);
    $controller->login();
    $result = $controller->getEnvelopeStatus();
    $form["elements"]["lender_confirmation"]["envelope_status"]["#default_value"] = $result["status"];
    


}

function application_send_request(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);

    $client = \Drupal::httpClient();

    $headers = [
        'Content-Type' => 'application/json',
        'Authorization' => 'Token 7f4d183d617b693c3ad355006c2d7381745e49c6',
        'Vendor-Key' => 'de512795-a13f-4812-8d47-ed41adaa6d32'
    ];
    $request_data = application_create_forgiveness_data($elements);


    $url = "https://sandbox.forgiveness.sba.gov/api/ppp_loan_forgiveness_requests/";
    
    $response = $client->request('POST', $url, [
        'headers' => $headers,
        'body' => $request_data,
    ]);
    $body = json_decode($response->getBody());
    dpm($body);

    dpm($body->{"etran_loan"}->{"slug"});
    
    $etran_loan = $body->{"etran_loan"};
    $slug = $etran_loan->{"slug"};

    $entity = $form_state->getFormObject()->getEntity();
    $data = $entity->getData();
    $data["sba_etran_loan_uuid"] = $slug;
    $entity->setData($data);
    $entity->save();
    
    $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"]["#value"] = $slug;
    $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"]["#default_value"] = $slug;
    
    return $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"];
}

function application_create_forgiveness_data(array &$elements) {
    $request_data = new stdClass();
    $etran_loan = new stdClass();
    $order = array("$", " ", ",");

    $bank_notional_amount = str_replace($order, "", $elements["ppp_loan_amount"]["#default_value"]);
    $forgive_amount = str_replace($order, "", $elements["forgive_amount"]["#default_value"]);
    
    $time = strtotime($elements["ppp_loan_disbursement_date"]["#default_value"]);
    $funding_date = date('Y-m-d', $time);

    $etran_loan->bank_notional_amount = $bank_notional_amount;
    $etran_loan->sba_number = $elements["sba_ppp_loan_number"]["#default_value"];
    $etran_loan->loan_number = $elements["lender_ppp_loan_number"]["#default_value"];
    $etran_loan->entity_name = $elements["business_legal_name_borrower"]["#default_value"];
    $etran_loan->ein = $elements["business_tin_ein_ssn_"]["#default_value"];
    $etran_loan->funding_date = $funding_date;
    $etran_loan->forgive_eidl_amount = str_replace($order, "", $elements["eidl_advance_amount_if_applicable_"]["#default_value"]);
    $eidl_application_number = $elements["eidl_application_number_if_applicable"]["#default_value"];
    if (empty($eidl_application_number) || $eidl_application_number == 0) {
        $etran_loan->forgive_eidl_application_number = null;
    }
    else {
        $etran_loan->forgive_eidl_application_number = $eidl_application_number;
    }
    
    $etran_loan->address1 = $elements["business_street_address"]["#default_value"];
    $etran_loan->address2 = $elements["city_state_zip"]["#default_value"];
    $etran_loan->dba_name = $elements["dba_or_trade_name_if_applicable"]["#default_value"];
    $etran_loan->phone_number = $elements["phone_number"]["#default_value"];
    $etran_loan->forgive_fte_at_loan_application = $elements["employees_at_time_of_loan_application"]["#default_value"];
    $etran_loan->forgive_amount = $forgive_amount;
    $etran_loan->forgive_fte_at_forgiveness_application = $elements["employees_at_time_of_forgiveness_application"]["#default_value"];
    $etran_loan->primary_email = $elements["email_address"]["#default_value"];
    $etran_loan->primary_name = $elements["primary_contact"]["#default_value"];
    $etran_loan->ez_form = false;
    $etran_loan->forgive_lender_confirmation = true;
    $etran_loan->forgive_lender_decision = 1;
    $etran_loan->s_form = true;
    $request_data->etran_loan = $etran_loan;

    return json_encode($request_data);
}

function application_upload_document(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);

    $client = \Drupal::httpClient();

    $headers = [
        'Authorization' => 'Token 7f4d183d617b693c3ad355006c2d7381745e49c6',
        'Vendor-Key' => 'de512795-a13f-4812-8d47-ed41adaa6d32'
    ];
    
    $etran_loan_uuid = $elements["sba_etran_loan_uuid"]["#default_value"];

    $url = "https://sandbox.forgiveness.sba.gov/api/ppp_loan_documents/";
    
    $response = $client->request('POST', $url, [
        'headers' => $headers,
        'multipart' => [
            [
                "name" => "name",
                "contents" => "SBA_PPP_Loan_Forgiveness_Application_Form_3508S.pdf",
            ],
            [
                "name" => "document_type",
                "contents" => 1
            ],
            [
                "name" => "etran_loan",
                "contents" => $etran_loan_uuid,
            ],
            [
                "name" => "document",
                "contents" => fopen('/Users/Isamu/Documents/SBA_PPP_Loan_Forgiveness_Application_Form_3508S.pdf', 'r')
            ]
        ]
    ]);
    $body = json_decode($response->getBody());
    dpm($body);
    
    $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"]["#value"] = $body->{"results"};
    $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"]["#default_value"] = $body->{"results"};
    
    return $form["elements"]["lender_confirmation"]["sba_etran_loan_uuid"];
}

function application_download_docusign_document(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $controller = new SBALFAController($elements);
    $controller->login();
    $file_name = $controller->downloadForgivenessForm();
    $host_name = "https://alcppp.com";
    #$host_name = "http://127.0.0.1";
    $file_path = "/sites/default/files/private/webform/apply_for_flp_loan/" . $file_name;
    $file_url = $host_name . $file_path;
    $form["elements"]["lender_confirmation"]["docusign_file_link"]["#template"] = 
        '<a href="' . $file_url . '">3508S Form.pdf</a>';
    
    return $form["elements"]["lender_confirmation"]["docusign_file_link"];
}