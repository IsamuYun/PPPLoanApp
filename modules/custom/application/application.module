<?php

/**
 * @file
 * Manage Application Submission Module
 */
use Drupal\Component\Utility\Variable;
use Drupal\webform\Utility\WebformFormHelper;
use Drupal\Core\Render\Element;
use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\AlertCommand;
use Drupal\Core\Form\FormStateInterface;

use Drupal\application\Controller\ApplicationController;
use Drupal\application\Controller\SBAForgivenessRequestController;
use Drupal\application\Controller\SBALFAController;
use Drupal\application\Controller\LenderController;
use Drupal\application\Controller\SBALoanController;

function application_form_webform_submission_apply_for_ppp_loan_edit_all_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);
    $application_controller = new ApplicationController($elements);
    $application_controller->login();
    $borrower_result = $application_controller->downloadBorrowerForm($form, $form_state);
    $sba_result = $application_controller->downloadSBADocuments($form, $form_state);
    
    $form["elements"]["loan_officer_page"]["#prefix"] = '<div id="loan-officer-ajax-wrapper">';
    $form["elements"]["loan_officer_page"]["#suffix"] = "</div>";

    $form["elements"]["loan_officer_page"]["btn_save_status"] = [
        "#type" => "button",
        "#value" => "Save",
        "#ajax" => [
            "callback" => "application_save_data",
            "event" => "click",
            "wrapper" => "loan-officer-ajax-wrapper",
            "progress" => [
                "type" => "throbber",
                "message" => "Saving...",
            ],
        ]
    ];

    $form["elements"]["loan_officer_page"]["btn_send_borrower_form"] = [
        "#type" => "button",
        "#value" => "Send Borrower App",
        "#ajax" => [
            "callback" => "application_send_borrower_docusign_form",
            "event" => "click",
            "wrapper" => "loan-officer-ajax-wrapper",
            "progress" => [
                "type" => "throbber",
                "message" => "Sending...",
            ],
        ]
    ];
    
    $form["elements"]["loan_officer_page"]["btn_request_to_sba"] = [
        "#type" => "button",
        "#value" => "Submit to SBA",
        "#ajax" => [
            "callback" => "application_request_to_sba",
            "event" => "click",
            "wrapper" => "loan-officer-ajax-wrapper",
            "progress" => [
                "type" => "throbber",
                "message" => "Requesting...",
            ],
        ]
    ];

    $form["elements"]["loan_officer_page"]["btn_send_sba_note"] = [
        "#type" => "button",
        "#value" => "Send Note/EO",
        "#ajax" => [
            "callback" => "application_send_sba_note",
            "event" => "click",
            "wrapper" => "loan-officer-ajax-wrapper",
            "progress" => [
                "type" => "throbber",
                "message" => "Requesting...",
            ],
        ]
    ];

    $form["elements"]["loan_officer_page"]["btn_send_lender_form"] = [
        "#type" => "button",
        "#value" => "Send Lender Form",
        "#ajax" => [
            "callback" => "application_send_lender_docusign_form",
            "event" => "click",
            "wrapper" => "loan-officer-ajax-wrapper",
            "progress" => [
                "type" => "throbber",
                "message" => "Sending...",
            ],
        ]
    ];
    
    if ($elements["loan_officer"]["#default_value"] == 0) {
        $officer_uid = \Drupal::currentUser()->id();
        $elements["loan_officer"]["#value"] = $officer_uid;
        $elements["loan_officer"]["#default_value"] = $officer_uid;
        $officer_uid = \Drupal::currentUser()->id();
        $entity = $form_state->getFormObject()->getEntity();
        $data = $entity->getData();
        $data["loan_officer"] = $officer_uid;
        $entity->setData($data);
        $entity->save();
    }

    if (empty($elements["adjusted_loan_amount"]["#default_value"])) {
        $elements["adjusted_loan_amount"]["#value"] = $application_controller->getLoanAmount();
        $elements["adjusted_loan_amount"]["#default_value"] = $application_controller->getLoanAmount();
    }

    if (empty($elements["adjusted_average_payroll"]["#default_value"])) {
        $elements["adjusted_average_payroll"]["#value"] = $application_controller->getAveragePayrollAmount();
        $elements["adjusted_average_payroll"]["#default_value"] = $application_controller->getAveragePayrollAmount();
    }
    
    $controller = new LenderController();
    $controller->createLenderFormPDF($form, $form_state);

    $sba_controller = new SBALoanController();
    $sba_controller->getLoanStatus($form, $form_state);
    return $form["elements"]["loan_officer_page"];
}

function application_form_webform_submission_apply_for_flp_loan_add_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);
    // calculate forgive amount
    $order = array("$", " ", ",");

    #$forgiveness_amount = str_replace($order, "", $elements["forgiveness_calculation"]["#default_value"]);
    #$eidl_amount = str_replace($order, "", $elements["eidl_advance_amount_if_applicable_"]["#default_value"]);

    #$forgive_amount = $forgiveness_amount - $eidl_amount;

    #$elements["forgive_amount"]["#default_value"] = $forgive_amount;
    $controller = new SBALFAController($elements);
    $controller->login();
    $form['actions']['submit']['#submit'][]  = 'application_send_fogive_form';
}

function application_form_webform_submission_apply_for_ppp_loan_add_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    #$elements = WebformFormHelper::flattenElements($form);
    #$office_list = $elements["loan_officer"]["#options"];
    #$office_id_list = array_keys($office_list);
    #dpm($office_id_list);
    #dpm($office_id_list[0]);
    #$elements["loan_status"]["#default_value"] = "Received";
    $form['actions']['submit']['#submit'][]  = 'application_submit_borrower_form';
}

function application_submit_borrower_form(array &$form, FormStateInterface &$form_state) {
    $entity = $form_state->getFormObject()->getEntity();
    $data = $entity->getData();
    $data["loan_status"] = "Received";
    $entity->setData($data);
    $entity->save();
    #$elements = WebformFormHelper::flattenElements($form);
    return $form["elements"]["loan_officer_page"];
}

function application_save_data(array &$form, FormStateInterface &$form_state) {
    $entity = $form_state->getFormObject()->getEntity();
    $data = $entity->getData();
    $data["adjusted_loan_amount"] = $form["elements"]["loan_officer_page"]["adjusted_loan_amount"]["#default_value"];
    $entity->setData($data);
    $entity->save();
    return $form["elements"]["loan_officer_page"];
}

function application_send_borrower_docusign_form(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $application_controller = new ApplicationController($elements);
    $application_controller->login();
    $application_controller->sendBorrowerDocuSignForm($form, $form_state);
    return $form["elements"]["loan_officer_page"];
}

function application_request_to_sba(array &$form, FormStateInterface $form_state) {
    $controller = new SBALoanController();
    $controller->sendLoanRequest($form, $form_state);
    return $form["elements"]["loan_officer_page"];
}

function application_send_lender_docusign_form(array &$form, FormStateInterface $form_state) {
    $controller = new LenderController();
    $controller->createLenderFormPDF($form, $form_state);
    return $form["elements"]["loan_officer_page"];
}

function application_send_sba_note(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $application_controller = new ApplicationController($elements);
    $application_controller->login();
    $application_controller->sendSBANote($form, $form_state);
    return $form["elements"]["loan_officer_page"];
}

function application_form_webform_submission_apply_for_flp_loan_edit_all_form_alter(array &$form, FormStateInterface &$form_state, $form_id) {
    $elements = WebformFormHelper::flattenElements($form);
    
    $form["elements"]["lender_confirmation"]["#prefix"] = '<div id="lender-confirmation-ajax-wrapper">';
    $form["elements"]["lender_confirmation"]["#suffix"] = "</div>";

    $file_url = $form["elements"]["lender_confirmation"]["form_file_name"]["#default_value"];
    $url = '';
    if ($file_url) {
        $url = '<a href="' . $file_url . '">3508S Form</a>';
    }

    $form["elements"]["lender_confirmation"]["docusign_file_link"] = [
        '#type' => 'inline_template',
        '#template' => $url
    ];
    /*
    // Button of download file
    $form["elements"]["lender_confirmation"]["btn_download_document"] = [
        '#type' => 'button',
        '#value' => 'Download Docusign Form',
        '#ajax' => [
            'callback' => 'application_download_docusign_document',
            'event' => 'click',
            'wrapper' => 'lender-confirmation-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ]
    ];
    */
    // Button of re-create docusign form
    $form["elements"]["lender_confirmation"]["btn_resend_forgive_form"] = [
        '#type' => 'button',
        '#value' => 'Resend Docusign Form',
        '#ajax' => [
            'callback' => 'application_send_fogive_form',
            'event' => 'click',
            'wrapper' => 'lender-confirmation-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ],
    ];

    $form["elements"]["lender_confirmation"]["btn_send_request"] = [
        '#type' => 'button',
        '#value' => 'Send to SBA',
        '#ajax' => [
            'callback' => 'application_send_request',
            'event' => 'click',
            'wrapper' => 'lender-confirmation-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ],
    ];

    $form["elements"]["lender_confirmation"]["btn_upload_document"] = [
        '#type' => 'button',
        '#value' => 'Upload',
        '#ajax' => [
            'callback' => 'application_upload_document',
            'event' => 'click',
            'wrapper' => 'lender-confirmation-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ],
    ];

    $form["elements"]["lender_confirmation"]["btn_delete_request"] = [
        '#type' => 'button',
        '#value' => 'Withdraw Request',
        '#ajax' => [
            'callback' => 'application_delete_request',
            'event' => 'click',
            'wrapper' => 'lender-confirmation-ajax-wrapper',
            'progress' => [
                'type' => 'throbber',
                'message' => "Verifying",
            ],
        ],
    ];
    
    // calculate forgive amount
    $order = array("$", " ", ",");

    #$forgiveness_amount = str_replace($order, "", $elements["forgiveness_calculation"]["#default_value"]);
    #$eidl_amount = str_replace($order, "", $elements["eidl_advance_amount_if_applicable_"]["#default_value"]);

    #$forgive_amount = $forgiveness_amount - $eidl_amount;
    #$elements["forgive_amount"]["#default_value"] = $forgive_amount;
    
    $controller = new SBALFAController($elements);
    $controller->login();
    $controller->downloadForgivenessForm($form, $form_state);
    
    $controller2 = new SBAForgivenessRequestController();
    $controller2->getRequestStatus($elements, $form, $form_state);

}

function application_send_request(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);

    $controller = new SBAForgivenessRequestController();
    $controller->sendForgivenessRequest($elements, $form, $form_state);
    
    return $form["elements"]["lender_confirmation"];
}

function application_delete_request(array &$form, FormStateInterface $form_state) {
    $controller = new SBAForgivenessRequestController();
    $controller->deleteRequest($form, $form_state);
    return $form["elements"]["lender_confirmation"];
}

function application_upload_document(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);

    $controller = new SBAForgivenessRequestController();
    $controller->uploadDocument($elements, $form, $form_state);
    
    return $form["elements"]["lender_confirmation"];
}

function application_download_docusign_document(array &$form, FormStateInterface $form_state) {
    $controller = new SBALFAController($elements);
    $controller->login();
    $controller->downloadForgivenessForm($form, $form_state);
    return $form["elements"]["lender_confirmation"];
}

function application_send_fogive_form(array &$form, FormStateInterface $form_state) {
    $elements = WebformFormHelper::flattenElements($form);
    $controller = new SBALFAController($elements);
    $controller->login();
    $result = $controller->sendForm();
    if (!empty($result) && isset($result["envelope_id"])) {
        $entity = $form_state->getFormObject()->getEntity();
        $data = $entity->getData();
        $data["envelope_id"] = $result["envelope_id"];
        $data["envelope_status"] = "sent";
        $data["form_file_name"] = "";
        $entity->setData($data);
        $entity->save();
        $form["elements"]["lender_confirmation"]["form_file_name"]["#value"] = "";
        $form["elements"]["lender_confirmation"]["form_file_name"]["#default_value"] = "";
        $form["elements"]["lender_confirmation"]["envelope_status"]["#value"] = "sent";
        $form["elements"]["lender_confirmation"]["envelope_status"]["#default_value"] = "sent";
        $form["elements"]["lender_confirmation"]["envelope_id"]["#value"] = $result["envelope_id"];
        $form["elements"]["lender_confirmation"]["envelope_id"]["#default_value"] = $result["envelope_id"];
    }
    
    return $form["elements"]["lender_confirmation"];
}

function application_webform_submission_form_alter(array &$form, FormStateInterface &$form_state, $form_id){
    if(in_array($form_id, ['webform_submission_apply_for_flp_loan_add_form', 'webform_submission_apply_for_flp_loan_edit_form']) && isset($_SESSION['_symfony_flashes']['status']) && is_array($_SESSION['_symfony_flashes']['status'])) {
        foreach($_SESSION['_symfony_flashes']['status'] as $idx => $msg) {
            $msg_txt = "";
            if (is_string($msg)) {
                $msg_txt = $msg;
            }
            else {
                $msg_txt = $msg->__toString();
            }
            if (strpos($msg_txt, 'pending draft') !== false)  unset($_SESSION['_symfony_flashes']['status'][$idx]);
        }
        if(count($_SESSION['_symfony_flashes']['status']) == 0) unset($_SESSION['_symfony_flashes']['status']);
    }
}



/**
 * Implements hook_webform_element_alter().
 *
 * @param array              $element
 * @param FormStateInterface $form_state
 * @param array              $context
 */
function application_webform_element_alter(array &$element, FormStateInterface $form_state, array $context) {
  // check for desired element
  if (isset($element['#webform_id']) && $element['#webform_id'] === 'apply_for_ppp_loan--date_of_birth') {
    $element['#element_validate'][] = [
      'Drupal\application\Validate\ApplicationValidate',
      'birthdayValidate'
    ];
  }
}